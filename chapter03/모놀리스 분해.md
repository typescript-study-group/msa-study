# 🏗 모놀리스 분해

## 🤔 어떻게 분해를 할까?

### 🎯 목표를 명확히 하라
- 마이크로서비스는 그 자체가 목표가 되어서는 안 된다.
- 목표를 명확히 하고, 목표 달성을 위한 가장 적합한 옵션이어야 한다.
- 마이크로서비스가 가져오는 복잡성을 고려할 때 발생할 수 있는 다양한 문제들을 인지해야 한다.
- 마이크로서비스가 아니라 더 쉬운 방식으로 목표에 도달하기 위한 방법이 존재하는지 생각해야 한다.

### 🐢 점진적으로 진행하라
> the only thing a Big Bang rewrite guarantees is a Big Bang!
<br> - Martin Fowler

- 한 번에 끝내려고 하지 말아야 한다.
- 단계별 리스크를 최소화하고, 빠른 롤백을 위해 작은 단위로 나누어 점진적으로 전환해야 한다.
- 단위를 작게 나눌수록 더 세밀한 학습이 가능하고, 분해 가속력을 얻기 용이해진다.
- 급한 마음에 빅뱅식으로 전환하게 된다면 MSA가 가져올 공포와 고통을 견디지 못할 것이다.

### 🚫 모놀리스가 쓰레기는 아니다
- `모놀리스가 없는 것`에 집중하지 말고, 아키텍처 변경이 가져올 혜택에 집중해야 한다.

### 🐢 조급한 분해는 금지
- 도메인에 대한 이해가 명확하지 않을 때 조급하게 분해하려고 하면 엄청난 리스크가 생긴다.
  - 예를 들어 무작정 MSA로 전환 도중, 분리해 두었던 특정 도메인들이 하나의 도메인이었어야 한다거나, 반대로 다시 분리를 해야 할 수도 있다.
- 서비스를 분해하고 다시 되돌리는 것은 엄청난 코스트를 요구한다.

## 🧩 무엇을 먼저 나눌까?

### 🪓 추출 작업의 용이성 + 추출 이점
- 간단하게 표현하자면 추출이 쉬워야 한다.
- 기존의 모놀리틱 애플리케이션에서 강결합 상태인 기능부터 뜯어내려고 하면 굉장히 힘들어진다.
- 또한, 강결합인 기능은 보통 서비스에서 중요한 기능일 확률이 높은데, 작업 후 어떤 사고가 발생할지 예측하기가 힘들다.
- `쉬운 쪽에 가까운 것들을 선택하여 조금씩 추진력을 만들자.`
  - 목표 달성에 어느 정도 영향을 미칠 수 있는 것으로 선택하되, 낮은 곳에 달린 과일처럼 쉽게 성취할 수 있는 것을 고르자.

## 🛠 어떻게 나눌까?

### 🌳 Strangler Fig Application Pattern

![fig](./images/fig.webp)
> 숙주를 서서히 잠식하며 성장하는 나무

- 교살자 무화과나무 패턴은 간단히 기존의 서비스를 점진적으로 대체해 나가는 패턴이라고 생각하면 된다.
- 리스크가 적고 쉽게 롤백이 가능하다.
- 인터셉트 레이어를 활용하여 기존의 서비스에서 점진적으로 대체 서비스로 전환시켜 나간다.

### ⚖️ 병렬 실행
- 기존의 모놀리식 애플리케이션의 기능과 마이크로서비스 기능을 병렬 실행하여 결과를 비교하여 사용한다.
  `추후 챕터에서 자세히 다룰 예정`

### 🔄 기능 토글
- 말 그대로 기능을 켜거나 끄며 서로 다른 구현 사이를 오가는 것을 말한다.
- 프록시 레이어에서 구현하여 제어한다.
- 교살자 무화과 패턴과 유사하다.

## 📊 데이터 분해 시 고려사항

### ⚡️ 성능
- 모놀리식일 때는 데이터 계층이 모두 하나로 되어 있기 때문에 `join`이 편하다.
- 데이터 가공이 한곳에서 모두 이루어지기 때문에 다루기 쉽다는 이야기인데, MSA로 분리되게 된다면 데이터 계층에서 가공하던 데이터들을 애플리케이션 레벨로 이동시켜야 한다.
  - 예를 들어 A와 B가 기존에 간단히 조인으로 조회하여 내려주고 있었다면, A를 조회하고 B에 요청하여 정보를 받아 두 개를 합쳐 응답을 내려줘야 하는 상황이 된다.
  - 이 경우 성능이 과연 기존 모놀리식 방식보다 빠를까?
  - 대용량 트래픽 혹은 데이터일 경우에는 그렇지 않을 것이다.

### 🔐 데이터 무결성
- 기존 하나의 DB를 사용할 경우에는 테이블 간 관계 설정을 활용하여 참조하는 테이블의 데이터가 반드시 존재할 것이라는 것이 보장되었다.
- 그러나 DB가 분리될 경우 이와 같은 방식으로 무결성을 보장할 수 없기 때문에 추가적인 고민이 필요하다.

### 🔄 트랜잭션
- 이미 너무 잘 알고 있는 문제다.
  - `추후 챕터에서 자세하게 다룰 예정`

## 🏁 그래서 결론은?
- MSA로 전환하려고 한다면 달성하고자 하는 목표가 무엇인지를 먼저 명확히 해라.
  - MSA로의 전환이 목표가 되어서는 안 되고, 목표 달성을 위한 수단이 되어야 한다.
- Migration은 점진적으로 진행해야 한다.
  - Big Bang을 하려 한다면 정말 Big Bang이 되어버릴 것이다.
- `작은 단위 변경` -> `반영` -> `평가` 이러한 형태로 시작하자.